const questionText = document.getElementById("question-text");
const answerInput = document.getElementById("answer-input");
const checkAnswerButton = document.getElementById("check-answer");
const showDefinitionButton = document.getElementById("show-definition");
const speakButton = document.getElementById("speak-button");
const nextButton = document.getElementById("next-button");
const definitionText = document.getElementById("definition-text");
const exampleText = document.getElementById("example-text");
const progressBar = document.getElementById("progress-bar");
const wordBox = document.querySelector('.word-box');

let words = [];
let currentWordIndex = 0;
let touchStartX = null;
let touchEndX = null;
const swipeThreshold = 50;

async function loadWordsFromCSV(filePath) {
    try {
        const response = await fetch(filePath);
        const csvData = await response.text();
        const lines = csvData.trim().split('\n');
        const headers = lines[0].split(',').map(header => header.trim());

        words = lines.slice(1).map(line => {
            const values = line.split(',').map(value => value.trim());
            return Object.fromEntries(headers.map((key, i) => [key, values[i]]));
        });

        displayQuestion();
    } catch (error) {
        console.error("Error loading CSV:", error);
        questionText.textContent = "Error loading word list.";
    }
}

function displayQuestion() {
    if (currentWordIndex >= words.length) {
        questionText.textContent = "You've completed the quiz!";
        [answerInput, checkAnswerButton, showDefinitionButton, speakButton, nextButton].forEach(el => el.style.display = "none");
        return;
    }

    const { sentence, word } = words[currentWordIndex];
    const wordList = word.split(' ');
    let blankSentence = sentence;

    wordList.forEach(w => {
        const regex = new RegExp(`\\b${w}\\b`, 'gi');
        blankSentence = blankSentence.replace(regex, '________');
    });

    questionText.textContent = blankSentence;
    answerInput.value = "";
    definitionText.style.display = "none";
    exampleText.style.display = "none";
    progressBar.style.width = `${((currentWordIndex + 1) / words.length) * 100}%`;
}

checkAnswerButton.addEventListener("click", function() {
    const userAnswers = answerInput.value.trim().toLowerCase().split(' ');
    const correctAnswers = words[currentWordIndex].word.toLowerCase().split(' ');

    if (JSON.stringify(userAnswers.sort()) === JSON.stringify(correctAnswers.sort())) {
        exampleText.textContent = "Correct!";
        exampleText.classList.add("correct");
    } else {
        exampleText.textContent = `Incorrect. Correct words: ${words[currentWordIndex].word}`;
        exampleText.classList.add("incorrect");
    }
    exampleText.style.display = "block";
});

showDefinitionButton.addEventListener("click", function() {
    definitionText.textContent = words[currentWordIndex].definition;
    definitionText.style.display = "block";
});

speakButton.addEventListener("click", function() {
    speechSynthesis.speak(new SpeechSynthesisUtterance(words[currentWordIndex].word));
});

nextButton.addEventListener("click", function() {
    if (currentWordIndex < words.length - 1) {
        currentWordIndex++;
        displayQuestion();
    }
});

wordBox.addEventListener('touchstart', event => touchStartX = event.changedTouches[0].screenX);
wordBox.addEventListener('touchend', event => {
    touchEndX = event.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    if (!touchStartX || !touchEndX) return;
    const deltaX = touchEndX - touchStartX;
    if (deltaX < -swipeThreshold && currentWordIndex < words.length - 1) {
        currentWordIndex++;
        displayQuestion();
    } else if (deltaX > swipeThreshold && currentWordIndex > 0) {
        currentWordIndex--;
        displayQuestion();
    }
    touchStartX = touchEndX = null;
}

loadWordsFromCSV('English_Learning.csv');
