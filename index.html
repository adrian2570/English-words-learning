<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS App - Expressive US Voice</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
            background-color: #f4f4f4;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
        }
        select, button, input {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button.stop {
            background-color: #f44336;
        }
        button.stop:hover {
            background-color: #d32f2f;
        }
        #status {
            color: #333;
            margin-top: 10px;
        }
        .slider-container {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h2>Text-to-Speech (Expressive US Voice)</h2>
    <textarea id="textInput" placeholder="Enter text to speak (e.g., 'Wow, this is great! How are you?')"></textarea>
    <br>
    <select id="voiceSelect"></select>
    <div class="slider-container">
        <label for="pitch">Base Pitch: <span id="pitchValue">1.2</span></label>
        <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1.2">
    </div>
    <div class="slider-container">
        <label for="rate">Base Rate: <span id="rateValue">0.9</span></label>
        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="0.9">
    </div>
    <button onclick="speak()">Speak</button>
    <button class="stop" onclick="stop()">Stop</button>
    <p id="status"></p>

    <script>
        const synth = window.speechSynthesis;
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const status = document.getElementById('status');
        const pitch = document.getElementById('pitch');
        const rate = document.getElementById('rate');
        const pitchValue = document.getElementById('pitchValue');
        const rateValue = document.getElementById('rateValue');
        let voices = [];

        // Update slider values
        pitch.addEventListener('input', () => pitchValue.textContent = pitch.value);
        rate.addEventListener('input', () => rateValue.textContent = rate.value);

        // Process text for expressiveness
        function processText(text) {
            // Add pauses and emphasis
            let processed = text
                .replace(/\. /g, ', ') // Add pause after periods
                .replace(/! /g, ', uhm, ') // Pause after exclamations
                .replace(/\? /g, ', well, '); // Pause after questions
            // Emphasize emotional words
            processed = processed.replace(/\b(great|amazing|awesome|wow)\b/gi, '$1, $1!');
            return processed;
        }

        // Split text into sentences for varied prosody
        function splitIntoSentences(text) {
            return text.match(/[^.!?]+[.!?]+/g) || [text];
        }

        // Assign pitch/rate based on sentence type
        function getProsody(sentence, basePitch, baseRate) {
            let pitch = basePitch;
            let rate = baseRate;
            if (sentence.includes('!') || sentence.match(/\b(wow|amazing|great)\b/i)) {
                pitch = basePitch * 1.2; // Higher pitch for excitement
                rate = baseRate * 0.9; // Slightly slower for emphasis
            } else if (sentence.includes('?')) {
                pitch = basePitch * 1.1; // Slightly higher for questions
                rate = baseRate; // Normal speed
            } else {
                pitch = basePitch * 0.9; // Lower pitch for calm statements
                rate = baseRate * 1.1; // Slightly faster
            }
            return { pitch: Math.min(Math.max(pitch, 0.5), 2), rate: Math.min(Math.max(rate, 0.5), 2) };
        }

        // Load US English voices, prioritize neural
        function loadVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '<option value="">Select a voice</option>';
            voices.forEach(voice => {
                if (voice.lang.startsWith('en-US')) {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})${voice.name.includes('Neural') ? ' [Neural]' : ''}`;
                    voiceSelect.appendChild(option);
                }
            });
            const neuralVoice = voices.find(v => v.name.includes('Neural') && v.lang.startsWith('en-US'));
            if (neuralVoice) voiceSelect.value = neuralVoice.name;
            if (voices.length === 0) {
                status.textContent = 'No voices available. Try Chrome or Edge.';
            } else {
                status.textContent = 'Voices loaded. Ready to speak!';
                console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
            }
        }

        // Handle voice loading
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // Speak function with expressive prosody
        async function speak() {
            const text = textInput.value.trim();
            if (!text) {
                status.textContent = 'Error: Please enter some text!';
                return;
            }
            if (voices.length === 0) {
                status.textContent = 'Error: No voices available. Try Chrome or Edge.';
                return;
            }

            const processedText = processText(text);
            const sentences = splitIntoSentences(processedText);
            const selectedVoice = voices.find(voice => voice.name === voiceSelect.value) || { lang: 'en-US' };

            status.textContent = 'Speaking...';

            for (const sentence of sentences) {
                const { pitch: sentencePitch, rate: sentenceRate } = getProsody(sentence, parseFloat(pitch.value), parseFloat(rate.value));
                const utterance = new SpeechSynthesisUtterance(sentence.trim());
                utterance.voice = selectedVoice;
                utterance.lang = 'en-US';
                utterance.pitch = sentencePitch;
                utterance.rate = sentenceRate;
                utterance.volume = 1;

                utterance.onerror = (event) => {
                    status.textContent = `Speech error: ${event.error}`;
                    console.error('SpeechSynthesisUtterance error:', event);
                };

                // Promise to wait for utterance to finish
                await new Promise(resolve => {
                    utterance.onend = () => resolve();
                    synth.speak(utterance);
                });
            }

            status.textContent = 'Finished speaking.';
        }

        // Stop function
        function stop() {
            synth.cancel();
            status.textContent = 'Speech stopped.';
        }
    </script>
</body>
</html>
